pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
-- todo:
-- it's either a castle or a dungeon.
-- have the first screen be above the surface.
-- you can see the exit, but can't reach it.
-- you have to go down and navigate through the maze
-- to get to the exit.

--player
p1=
{
 --position
 x=72,
 y=16,
 --velocity
 dx=0,
 dy=0,
   
 --is the player standing on
 --the ground. used to determine
 --if they can jump.
 isgrounded=false,

 --tuning constants

 jumpvel=3.1,
 jumpframe=0,
 jumppressed=false
}

--globals
g=
{
 grav=0.4, -- gravity per frame
 maxdy=5,
 maxjumpframe=8,
 -- we move to another screen after camshft pixels
 -- this allows the final block on a screen to be displayed
 -- as the first block on the next screen.
 camshft=120
}

--camera
c=
{
 x=0,
 y=0
}

-- called 30 times per second
function _update()

 --remember where we started
 local startx=p1.x
 
 handle_jump(p1)
   
 --walk
 --
   
 p1.dx=0
 if btn(0) then --left
  p1.dx=-2
 end
 if btn(1) then --right
  p1.dx=2
 end
   
 --move the player left/right
 p1.x+=p1.dx
   
 --hit side walls
 --
   
 --check for walls in the
 --direction we are moving.
 local xoffset=0
 if p1.dx>0 then xoffset=7 end
   
 --look for a wall
 local h=mget((p1.x+xoffset)/8,(p1.y+7)/8)
 if fget(h,0) then
  --they hit a wall so move them
  --back to their original pos.
  --it should really move them to
  --the edge of the wall but this
  --mostly works and is simpler.
  p1.x=startx
 end
   
 --accumulate gravity
 p1.dy+=g.grav
 if p1.dy > g.maxdy then p1.dy=g.maxdy end
   
  --fall
  p1.y+=p1.dy

  --hit floor
  --
   
  --check bottom center of the
  --player.
  local v=mget((p1.x+4)/8,(p1.y+8)/8)
   
  --assume they are floating 
  --until we determine otherwise
  p1.isgrounded=false
   
  --only check for floors when
  --moving downward
  if p1.dy>=0 then
   --look for a solid tile
   if fget(v,0) then
    --place p1 on top of tile
    p1.y = flr((p1.y)/8)*8
    --halt velocity
    p1.dy = 0
    --allow jumping again
    p1.isgrounded=true
   end
  end
   
  --hit ceiling
  --
   
  --check top center of p1
  v=mget((p1.x+4)/8,(p1.y)/8)
   
  --only check for ceilings when
  --moving up
  if p1.dy<=0 then
   --look for solid tile
   if fget(v,0) then
    --position p1 right below
    --ceiling
    p1.y = flr((p1.y+8)/8)*8
    --halt upward velocity
    p1.dy = 0
   end
  end
    
  -- move the camera to another screen if necessary
  if p1.y>=(c.y+g.camshft) then c.y+=g.camshft end
  if p1.y<(c.y) then c.y-=g.camshft end
  if p1.x>=(c.x+g.camshft) then c.x+=g.camshft end
  if p1.x<(c.x) then c.x-=g.camshft end
end

function _draw()
 cls() --clear the screen
 camera(c.x, c.y)
 map()
 spr(1,p1.x,p1.y) --draw player
end

function handle_jump(p)
 --if on the ground and the
 --user presses x,c,or,up...
 local jumppressednew = (btn(2) or btn(4) or btn(5))
 if jumppressednew and not p.jumppressed then
  if p.isgrounded then
   p.dy=-p.jumpvel
   p.jumpframe=1
  end
 elseif jumppressednew then
  if p.jumpframe>0 then
   p.dy=-p.jumpvel
   p.jumpframe+=1
   if p.jumpframe>=g.maxjumpframe then
    p.jumpframe=0
   end
  end
 else
  p.jumpframe=0
 end
 p.jumppressed = jumppressednew
end
__gfx__
0000000000888880440444cc0000000000ceec000000000000000000000000000000000000000000000000000000000000000000000000000000000066566666
00000000008c0c80400004cc000000000cccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000066566666
00700700008000804cc0c4cc00000000cc9cc9cc0000000000000000000000000000000000000000000000000000000000000000000000000000000055555555
00077000008bbb8040cc044c00000000bccccccb0000000000000000000000000000000000000000000000000000000000000000000000000000000066666566
00077000008888804bbbb40c00000000bcc8c8cb0000000000000000000000000000000000000000000000000000000000000000000000000000000066666566
0070070000400040b0000b0c00000000cc8c8ccc0000000000000000000000000000000000000000000000000000000000000000000000000000000055555555
0000000000400040b0000b0c000000000cccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000066566666
0000000000440044bb000bbc0000000000cccc000000000000000000000000000000000000000000000000000000000000000000000000000000000066566666
00000000000000000bbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44442444444424b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44244444442444b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44424444444244b000a00004444000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44424244444242b00aaa0004488400000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b24424244244242b000b00004088040000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44424444444244b000b00000444400000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44444444444444b000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44444444444444b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44442444444424b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44244444442444b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44424444444244b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44424244444242b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b24424244244242b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44424444444244b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b44444444444444b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbb4444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444442444444424400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444244444442444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444424444444244400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444424244444242400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000424424244244242400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444424444444244400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000001000000000000000000000101010101000000000000000000000000010101010000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000d000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000f00000f0f000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000f000000000000000f000000000f0f00000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000f00000000000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000f0f00000f0000000f0f00000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000f00000000000f0f00000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000001000200000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000f0f0f0f0f0f0f0f0f0f0f0f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0000000000000f0000000000000f0f00000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000f0f00000f0f00000f0f000f000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f00000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000010e0000000000000e0e00000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0f0f0f0f0f00000f0f0f0f0f0f0f0f00000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000f0000000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000d0000000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000f00000f0f0000000000000f00000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000f000000000000000f000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000f00000000000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000f0f00000f0000000f0f00000f0f00000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000f00000000000f0f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000001000200000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000f0f0f0f0f0f0f0f0f0f0f0f00000f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0000000000000f0000000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f0000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000f0f00000f0f00000f0f000f000f0f00000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000010e00000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0110000027050200501605016050170501f050190502e050230502b0500f05016050150501f05011050120500d05013050100500a0500c0500e0500e0500b0500e0503e0503405029050122503a150111503f150
000800002e05013050120501f05021050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000c0000210502105000000210500000021050000002405029000210502105000000000001c0501c05000000000001c050000001f050000001c050000001f0501f05000000000000000000000000000000000000
002d00002105021050000002105000000210500000024050290002105021050000002605026050000002705027050000002805028050000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000003c0503c050360503b0502a050260501f0502205016050200500c0500b05027050290502a0502c0502c05035050250501d05018050180501e05022f501a0500f0501605017050170500f0500c05009050
__music__
00 03444344
00 04024344

