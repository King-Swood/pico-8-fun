pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
function _init()
    car1 = car_make(16, 10, 0)
    car2 = car_make(16, 18, 1)
end

function _update()
    car_update(car1)
    car_update(car2)
end

function _draw()
    cls()
    camera_draw()
    map_draw()
    car_draw(car1)
    car_draw(car2)
end
-->8
function car_make(x, y, p)
    local a = {}
    a.p = p
    a.x = x
    a.y = y
    a.m = 0
    a.slow = false
    a.a = 90

    return a
end

function mx_from_ma(m, a)
    local mult = 1
    if a > 180 then
        mult = -1
        a -= 180
    end

    local mx = 0
    if a <= 90 then
        mx = m * (a / 90)
    else
        mx = m * (1 - ((a - 90) / 90))
    end

    return mx * mult
end

function my_from_ma(m, a)
    return mx_from_ma(m, a - 90)
end

function car_update(a)
    local m_max = 1.5
    local m_inc = 0.2
    local m_dec = 0.1
    local r_inc = 5

    if btn(0, a.p) then
        a.a -= r_inc
    end
    if btn(1, a.p) then
        a.a += r_inc
    end
    if btn(2, a.p) then
        a.m += m_inc
    end
    if btn(3, a.p) then
        a.m -= m_inc
    end

    a.a = a.a % 360

    if a.m > m_max then
        a.m = m_max
    elseif a.m < -m_max then
        a.m = -m_max
    end

    a.x += mx_from_ma(a.m, a.a)
    a.y += my_from_ma(a.m, a.a)

    a.slow = false
    if (tile_flag_at(a.x, a.y) & 1) == 0 then a.slow = true end
    if (tile_flag_at(a.x + 7, a.y) & 1) == 0 then a.slow = true end
    if (tile_flag_at(a.x + 7, a.y + 7) & 1) == 0 then a.slow = true end
    if (tile_flag_at(a.x, a.y + 7) & 1) == 0 then a.slow = true end

    if a.slow then m_dec = m_dec * 3 end

    if a.m > m_dec then
        a.m -= m_dec
    elseif a.m < -m_dec then
        a.m += m_dec
    else
        a.m = 0
    end
end

function car_draw(a)
    if a.a >= 350 or a.a <= 10 then
        spr(2, a.x, a.y)
    elseif a.a >= 80 and a.a <= 100 then
        spr(48, a.x, a.y)
    elseif a.a >= 170 and a.a <= 190 then
        spr(49, a.x, a.y)
    elseif a.a >= 260 and a.a <= 280 then
        spr(50, a.x, a.y)
    else
        spr_r(2, a.x, a.y, a.a, 1, 1)
    end
end
-->8
function map_draw()
    map()
end

function camera_draw()
    camera(car1.x - 64, car1.y - 64)
end

function tile_at(x, y)
    return mget(x / 8, y / 8)
end

function tile_flag_at(x, y)
    return fget(tile_at(x, y))
end


function spr_r(s,x,y,a,w,h)
 sw=(w or 1)*8
 sh=(h or 1)*8
 sx=(s%8)*8
 sy=flr(s/8)*8
 x0=flr(0.5*sw)
 y0=flr(0.5*sh)
 a=a/360
 sa=sin(a)
 ca=cos(a)
 for ix=0,sw-1 do
  for iy=0,sh-1 do
   dx=ix-x0
   dy=iy-y0
   xx=flr(dx*ca-dy*sa+x0)
   yy=flr(dx*sa+dy*ca+y0)
   if (xx>=0 and xx<sw and yy>=0 and yy<=sh) then
    local col=sget(sx+xx,sy+yy)
    if col != 0 then pset(x+ix,y+iy,col) end
   end
  end
 end
end

__gfx__
00000000666666660089880099999999000000005555555000000000000000000000000000222200000000000000000000000000000000000000000000000000
00000000666666661866668190000009000000000007055000004000000cc0000009900002000020000000000000000000000000000000000000000000000000
0070070066666666186986819000000900000000000005500000400000c00c000090090020000002000400000000000000000000000000000000000000000000
0007700066666666086986809000000900000000000700000000400000000c000000900020000002004000000000000000000000000000000000000000000000
000770006666666608698680900000090000000000000000000040000000c0000000090020000002004000000000000000000000000000000000000000000000
00700700666666661889888190000009000000000007000000004000000c00000090090020000002000400000000000000000000000000000000000000000000
0000000066666666188228819000000900000000000000000000400000cccc000009900002000020000044000000000000000000000000000000000000000000
000000006aaa6aaa0022220099999999000000000007000000004000000000000000000000222200000004000000000000000000000000000000000000000000
66666666006666666666660066666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666606666666666666606666666a666666660007000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666666666666666666666a666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666666666666666666666a666666660007000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666666666666666666666a666666660007000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6666666666666666666666666666666a666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
666666666666666a666666666666666a666666660007000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666666666666666666a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666666666666666666a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666666666666666666a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666666666666666666a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000006666666666666606666666a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000666666666666006aaa6aaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01100110002222000110011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08888880188228810888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
28866668188898818666688200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22999969086896808688882200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22888868086896809699992200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
28866668186896818666688200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08888880186666810888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01100110008898000110011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000010000000000000000000001010101010100000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0011010101010101010101010101010101010101010101010101010101010101010101120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0013101010141414141414141414141414141414141414141414141414141414141413140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0013140000000000000000000000000000000000000000000000000000000000000013140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0013140000000000000000000000000000000000000000000000000000000000000013140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0013010101010101010101010101010501010101010101010101010101010101010123140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0021141414141414141414141414141514141414141414141414141414141414141414220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
