pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
	p1init()
end
updater=4
function _update()
 updater+=1
 if (updater == 5) then
 if (btn(0)) then p1move(-1) end
 if (btn(1)) then p1move(1) end
 if (btn(5)) then p1jump() end
 --if (btn(3)) then p1move() end

 p1update()
 updater = 4
 end
end

function _draw()
 cls()
 map(0,0,0,0)
 spr(1,p1.x,p1.y)
 debug()
end

function debug()
 print("p1.x "..p1.x.." "..tostr(istilesolid(pixeltotile(p1.x),pixeltotile(p1.y))), 0, 0, 10)
 print("p1.ax "..p1.ax, 0, 6, 10)
 print("p1.y "..p1.y.." "..tostr(p1.jumping), 0, 12, 10)
end

function pixeltotile(px) return flr(px / 8) end

function istilesolid(x,y) return fget(mget(x,y),0) end
function istilesolidpx(x,y) return istilesolid(pixeltotile(x),pixeltotile(y)) end
-->8
p1={}
friction=0.5
gravity=0.5
pminspeed=1
pmaxspeed=4
jumptimemax=3

function p1init()
 p1.x = 60
 p1.y = 110
 p1.ax=0
 p1.ay=0
 p1.speeds=0.25 --speed slow
 p1.speedf=2.0 --speed fast
 p1.speedj=1.0 --speed jump
 p1.b_left=false
 p1.b_right=false
 p1.b_up=false
 p1.b_down=false
 p1.moving=false -- true if player moving left/right
 p1.grounded=false -- true if player is on a walkable surface
 p1.jumping=false -- true if player has jumped and is still holding the button
 p1.jumpallowed=false -- Stops the player from jumping multiple times if the jump button is held down
 p1.jumptime=0 -- counter for allowing the jump height to be increased over multiple frames
end

function p1move(x,fast)
  if (x > 0) then p1.b_right=true
  elseif (x < 0) then p1.b_left=true end
end

function p1jump()
 p1.b_up=true
end

function p1updatefriction()
  local speedtouse = p1.speeds
  if (not p1.grounded) then speedtouse/=2 end

  if (p1.b_right) then
    if (p1.ax > 0) then 
      p1.ax+=speedtouse
    else
      p1.ax+=speedtouse*2
    end
    p1.moving=true
    if (p1.ax > 0) and (p1.ax < pminspeed) then p1.ax=pminspeed end
    if (p1.ax > pmaxspeed) then p1.ax=pmaxspeed end
  elseif (p1.b_left) then
    if (p1.ax < 0) then 
      p1.ax-=speedtouse
    else
      p1.ax-=speedtouse*2
    end
    p1.moving=true
    if (p1.ax < 0) and (p1.ax > -pminspeed) then p1.ax=-pminspeed end
    if (p1.ax < -pmaxspeed) then p1.ax=-pmaxspeed end
  end

  if (p1.grounded and not p1.moving) then
    if (p1.ax>0) then p1.ax-=friction end
    if (p1.ax<0) then p1.ax+=friction end
    if(abs(p1.ax)<friction) then p1.ax=0 end
  end
  p1.b_right=false
  p1.b_left=false
  p1.moving = false
end

function p1updategravity()
  if (p1.b_up and (p1.grounded or p1.jumping) and (p1.jumptime < jumptimemax) and (p1.jumpallowed)) then
    p1.jumping=true
    p1.jumptime+=1
    p1.grounded=false
    if (p1.ay == 0) then p1.ay-=p1.speedj*2
    else p1.ay-=p1.speedj end
  else
    p1.jumping=false
    p1.jumptime=0
    if (p1.grounded) then
      p1.ay=0
      if (p1.b_up) then
        p1.jumpallowed=false
      else
        p1.jumpallowed=true
      end
    else
      if(p1.ay<10) then p1.ay+=gravity end
      p1.jumpallowed=false
    end
  end
  p1.b_up=false
end

function p1update()
 local i
 if (p1.ax > 0) then
  i=p1.x
  while (p1.x < flr(i+p1.ax)) do
   if (istilesolidpx(p1.x+8,p1.y)) or (istilesolidpx(p1.x+8,p1.y+7)) then
    p1.ax=0
    break
   end
   p1.x=p1.x+1
  end
 elseif (p1.ax < 0) then
  i=p1.x
  while (p1.x > flr(i-abs(p1.ax))) do
   if (istilesolidpx(p1.x-1,p1.y)) or (istilesolidpx(p1.x-1,p1.y+7)) then
    p1.ax=0
    break
   end
   p1.x=p1.x-1
  end
 end
  -- Check to see if the player is standing on a tile
  if (istilesolidpx(p1.x,p1.y+8)) or (istilesolidpx(p1.x+7,p1.y+8)) then
    p1.grounded=true
  else
    p1.grounded=false
  end

 if (p1.ay > 0) then
  i=p1.y
  while (p1.y < flr(i+p1.ay)) do
   if (istilesolidpx(p1.x,p1.y+8)) or (istilesolidpx(p1.x+7,p1.y+8)) then
    p1.ay=0
    p1.grounded=true
    break
   end
   p1.y=p1.y+1
  end
 elseif (p1.ay < 0) then
  i=p1.y
  while (p1.y > flr(i-abs(p1.ay))) do
   if (istilesolidpx(p1.x,p1.y-1)) or (istilesolidpx(p1.x+7,p1.y-1)) then
    p1.ay=0
    break
   end
   p1.y=p1.y-1
  end
 end

 p1updatefriction()
 p1updategravity()
end
__gfx__
00000000009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018881888
00000000099999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b00000000000022212221
007007009991999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009900b0990a0a000081888188
00077000999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000999999990090000012221222
0007700099cc91990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000949499490a0a0b0088188818
00700700099cc9900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000949499490000300021222122
000000000999c990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099949999000b030088818881
00000000009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999900000030022122212
__gff__
0000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000d0000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000000000f0f0000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000f00000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000f0f00000f0000000f0f00000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000f0000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000f00000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000000000000000f0000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f000f0f00000f0f00000f0f000f000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f00000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0000000e0000000000000e0e00000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
